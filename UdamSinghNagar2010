var shp=ee.FeatureCollection(usnagar);
Map.addLayer(shp, {},'District outlining');

var imgc = ee.ImageCollection("LANDSAT/LC08/C01/T1_SR")
    .filterBounds(usnagar)
    .filterDate('2020-04-01', '2020-04-09')
    .sort('CLOUD_COVER')
    .first()
    .clip(usnagar);

//Display the cliped image collection with visual parameters 
Map.addLayer(imgc, {
  bands: ['B4', 'B3', 'B2'], min: 0, max: 0.3, gamma: 1.4}, 'udamsinghnagar');

//Zoom to roi(usnagar)
Map.centerObject(imgc, 9);
var training_points = water.merge(forest).merge(urban).merge(agriculture).merge(barrenland);
print(training_points);
var training_data = imgc.sampleRegions({
                    collection:training_points,
                    properties: ['landcover'],
                    scale: 30})
print(training_data);
var classifier = ee.Classifier.smileRandomForest(28)
var classifier = classifier.train({features: training_data,
classProperty: "landcover",
inputProperties: ["B2","B3","B4","B5","B6","B7"]});
var classified_image = imgc.classify(classifier); 
Map.addLayer(classified_image, {min: 0, max: 4, palette: ['12faff','48f908','fd2408', 'daed11','645b51']},
'classified image');

// area
var water=classified_image.select('classification').eq(0);
var forest=classified_image.select('classification').eq(1);
var urban=classified_image.select('classification').eq(2);
var agriculture=classified_image.select('classification').eq(3);
var barrenland=classified_image.select('classification').eq(4);

//calculating the area of the classified image
var area_water=water.multiply(ee.Image.pixelArea()).divide(1000000);
var area_forest=forest.multiply(ee.Image.pixelArea()).divide(1000000);
var area_urban=urban.multiply(ee.Image.pixelArea()).divide(1000000);
var area_agriculture=agriculture.multiply(ee.Image.pixelArea()).divide(1000000);
var area_barrenland=barrenland.multiply(ee.Image.pixelArea()).divide(1000000);
//print("Area of water : ",area_water);

//reducing the stastistical area
var stat1=area_water.reduceRegion({
  reducer:ee.Reducer.sum(),
  geometry:usnagar,
  scale:30,
  maxPixels:1e9
});

var stat2=area_forest.reduceRegion({
  reducer:ee.Reducer.sum(),
  geometry:usnagar,
  scale:30,
  maxPixels:1e9
});

var stat3=area_urban.reduceRegion({
  reducer:ee.Reducer.sum(),
  geometry:usnagar,
  scale:30,
  maxPixels:1e9
});

var stat4=area_agriculture.reduceRegion({
  reducer:ee.Reducer.sum(),
  geometry:usnagar,
  scale:30,
  maxPixels:1e9
});

var stat5=area_barrenland.reduceRegion({
  reducer:ee.Reducer.sum(),
  geometry:usnagar,
  scale:30,
  maxPixels:1e9
});


print("Area of water in Sq KM: ",stat1);
print("Area of forest in Sq KM: ",stat2);
print("Area of urban in Sq KM: ",stat3);
print("Area of agriculture in Sq KM: ",stat4);
print("Area of barrenland in Sq KM: ",stat5);

//Add Title and Legends
 //Title //
Map.add(ui.Label(
    '2020 Land Cover Map of UDAM SINGH NAGAR',  {
      fontWeight: 'bold', BackgroundColor: 'FBF9F5',fontSize: '16px'}));
      
 // legend //
var names = [ 'Water','Forest', 'Urban','Agriculture','Barren Land' ];

var values = [ '0', '1', '2','3','4' ];
    
var legendsPalette = ['12faff','48f908','fd2408', 'daed11','645b51'];

// set position of panel
var legend = ui.Panel({style: { position: 'bottom-left', padding: '8px 15px'}});
 
// Create legend title
var legendTitle = ui.Label({value: 'Land Cover Legends ',style: {
  fontWeight: 'bold', fontSize: '20px', margin: '0 0 4px 0', padding: '0' }});
 
// Add the title to the panel
legend.add(legendTitle);
 
var makeRow = function(color, name) {
  // Create the label that is actually the colored box.
  var colorBox = ui.Label({
    style: {
      backgroundColor: '#' + color, padding: '8px',margin: '0 0 4px 0'} });

  // Create the label filled with the description text.
  var description = ui.Label({
    value: name, style: {margin: '0 0 4px 6px'}});

  // return the panel
  return ui.Panel({
    widgets: [colorBox, description],layout: ui.Panel.Layout.Flow('horizontal')})};
 
// Add color and and names
for (var i = 0; i < 5; i++) {
  legend.add(makeRow(legendsPalette[i], names[i]));
  }  

// Add the legend to the map.
Map.add(legend);

print(classifier.confusionMatrix()); 

// Create a geometry representing an export region.

// Export the image, specifying scale and region.
Export.image.toDrive({
  image: classified_image,
  description: 'imageToDriveExample',
  scale: 30,
  region: usnagar
});
var withRandom = training_data.randomColumn('random');
var split = 0.7; 
var trainingPartition = withRandom.filter(ee.Filter.lt('random', split));
var testingPartition = withRandom.filter(ee.Filter.gte('random', split));

var trainedClassifier = ee.Classifier.smileRandomForest(20).train({
  features: trainingPartition,
  classProperty: 'landcover',
inputProperties: ["B2","B3","B4","B5","B6","B7"]
});
var test_1 = testingPartition.classify(trainedClassifier);
var confusionMatrix_2020 = test_1.errorMatrix('landcover', 'classification');
print('Confusion Matrix 2020', confusionMatrix_2020);
print('Validation Overall Accuracy: ', confusionMatrix_2020.accuracy());
print('Kappa co-efficient: ', confusionMatrix_2020.kappa());


